<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="nico 0.5.0">
    <meta name="theme" content="spm 0.1">
    <title>如何使用Grunt构建一个中型项目？ - spm document</title>
    <link rel="stylesheet" href="../static/one.css" />
    <link rel="stylesheet" href="../static/syntax.css" />
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38943643-2']);
      _gaq.push(['_trackPageview']);
      _gaq.push(['_trackPageLoadTime']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div class="navigation" role="navigation">
        <h1 class="home"><a href="../">spmjs</a></h1>
        <div class="menu">
          <a style="color: #d00; font-weight: bold;" href="http://spmjs.io">[ 全新 spm3 现已发布 ]</a>
          <a href="../doc/">使用文档</a>
          <a href="../cli/config">命令集</a>
          <a href="../api/">开发者文档</a>
        </div>
    </div>
    <div id="color-bar"></div>

    <div class="row clearfix">
      <div class="column-left">
<div class="sidebar">
</div>
</div>
      <div class="column-right">
<div class="hentry typo">
  <h1 class="entry-title">如何使用Grunt构建一个中型项目？</h1>
  <div class="entry-toc">
    <h3>Table of Contents</h3>
    <ul><li><a href="#目录结构及说明">目录结构及说明</a></li><li><a href="#模块">模块</a></li><li><a href="#构建">构建</a></li></ul>
  </div>

  <div class="entry-content"><p>本文前提是你已经了解了<a href="http://seajs.org" title="seajs">seajs</a>和<a href="http://gruntjs.com/" title="grunt">grunt</a>。</p>
<p>阅读的同时可参照完整示例：    <a href="https://github.com/twinstony/seajs-grunt-build" title="seajs-grunt-build">seajs-grunt-build</a></p>
<p>一切准备就绪，那么就让我们开始吧！</p>
<h2 id="目录结构及说明">目录结构及说明</h2><p>示例是一个以js为主的项目，项目中的js服务于多个项目，所以你看起来路径结构可能会有些深。
js大致可以分为三层：</p>
<ol>
<li><p>base：如jquery等类库</p>
</li>
<li><p>module：自定义的模块</p>
</li>
<li><p>app：直接作用于业务</p>
</li>
</ol>
<pre>app                                 -- 特定项目特定页面的业务层js都在这里
    app1                            -- 其中的一个项目app1
        index                       -- app1中的首页
            src
                index.js            -- 业务模块
gallery                             -- base模块，spm提供的已经以CMD格式封装好的通用库都在这里
    jquery
        1.8.2
            jquery.js
html                                -- 项目页，真实的项目路径可能不在这里，将它放在这里权当是例子方便
    index
        index.html
node_modules                        -- grunt及其所需插件。注1
    grunt                           -- grunt
    grunt-cmd-concat                -- 依赖合并
    grunt-cmd-transport             -- 提取依赖并设置模块ID
    grunt-contrib-clean             -- 删除临时文件
    grunt-contrib-uglify            -- 压缩
seajs                               -- seajs
    1.3.1                           -- 由于我目前参与的项目全部卡在构建，故暂未升级到2.0
        seajs.js
styles                              -- 自定义模块
    component                       -- 这层结构的目的是可以将不同用途的模块区分，比如ui,util等
        dialog
            src
                dialog.js
                dialog_css.css
Gruntfile.js                        -- grunt配置文件
package.json                        -- 项目配置文件，该文件内容可以在grunt中引用
rootConfig.js                       -- 开发环境下使用的seajs配置文件</pre><p><em>注1：由于近期concat和transport变化较快，有些配置可能随新版本的发布而不可用，固提交个与例子相符的版本在这里。</em></p>
<h2 id="模块">模块</h2><p>首先，示例非常简单，通过点击页面中的按钮，弹出一个窗口。那么我们先把弹窗封装成一个模块吧：</p>
<div class="highlight"><pre><code class="javascript">define(<span class="function"><span class="keyword">function</span><span class="params">(require, exports, module)</span> {</span>
    <span class="keyword">var</span> $ = require(<span class="string">"jquery"</span>);
    require(<span class="string">"./dialog_css.css"</span>);

    <span class="function"><span class="keyword">function</span> <span class="title">Dialog</span><span class="params">(content, options)</span> {</span>
        ...
    }
    module.exports = Dialog;
})</code></pre></div><p>可以看到该模块还以相对路径为模块ID，依赖了一个css文件，来修饰窗口的样式。</p>
<p>然后为首页完成业务模块<code>index.js</code>：</p>
<div class="highlight"><pre><code class="javascript">define(<span class="function"><span class="keyword">function</span> <span class="params">(require, exports)</span> {</span>
    <span class="keyword">var</span> $ = require(<span class="string">"jquery"</span>),
        Dialog = require(<span class="string">"dialog"</span>);
    $(<span class="string">"#btnDialog"</span>).bind(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> mapDialog = <span class="keyword">new</span> Dialog({type: <span class="string">"text"</span>, value: <span class="string">'hello world!'</span>, width:<span class="string">'230px'</span>, height:<span class="string">'60px'</span>});
        mapDialog.show();
    })
});</code></pre></div><p>现在需要一个开发阶段seajs的配置文件<code>rootConfig.js</code>，并将其引入到页面中：</p>
<div class="highlight"><pre><code class="javascript">seajs.config({
    alias:{
        <span class="string">"jquery"</span>:<span class="string">"gallery/jquery/1.8.2/jquery"</span>,

        <span class="comment">/*弹窗*/</span>
        <span class="string">"dialog"</span>: <span class="string">"styles/component/dialog/src/dialog"</span>
    },
    debug:<span class="number">1</span>
});</code></pre></div><p>接下来我们来编写展示的页面<code>index.html</code>：</p>
<div class="highlight"><pre><code class="xml"><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;<span class="title">html</span>&gt;</span>
<span class="tag">&lt;<span class="title">head</span>&gt;</span>
    <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"UTF-8"</span> /&gt;</span>
    <span class="tag">&lt;<span class="title">title</span>&gt;</span><span class="tag">&lt;/<span class="title">title</span>&gt;</span>
<span class="tag">&lt;/<span class="title">head</span>&gt;</span>
<span class="tag">&lt;<span class="title">body</span>&gt;</span>
<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">id</span>=<span class="value">"btnDialog"</span> <span class="attribute">value</span>=<span class="value">"show me the money"</span>/&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"../../seajs/1.3.1/sea.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"../../rootConfig.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript">
    seajs.use(<span class="string">"../../app/app1/index/src/index.js"</span>)
</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="tag">&lt;/<span class="title">html</span>&gt;</span></code></pre></div><p>这时候运行刚刚完成的<code>index.html</code>，一切顺利的话，应该已经可以看到弹窗的效果了。
OK，前面的这些就是我们在开发阶段使用seajs的工作。接下来就是构建部分了。</p>
<h2 id="构建">构建</h2><p><strong>package.json</strong></p>
<p>首先，如果你不是最近才用seajs的话，应该对<code>package.json</code>不陌生，而且里面很可能也像我一样，定义了好多<code>alias</code>，
现在我们依然可以用上她们,这里为了能跟以后的spm2兼容做了些小的修改：</p>
<ol>
<li><code>root</code>-&gt;<code>family</code></li>
<li><code>alias</code>-&gt;<code>spm.alias</code></li>
</ol>
<div class="highlight"><pre><code class="javascript">{
    <span class="string">"family"</span>: <span class="string">"test"</span>,
    <span class="string">"version"</span>: <span class="string">"0.0.1"</span>,
    <span class="string">"name"</span>: <span class="string">"gruntTest"</span>,
    <span class="string">"spm"</span>: {
        <span class="string">"alias"</span>: {
            <span class="string">"jquery"</span>: <span class="string">"gallery/jquery/1.8.2/jquery"</span>,
            <span class="string">"dialog"</span>: <span class="string">"dist/styles/component/dialog/src/dialog"</span>
        }
    },
    <span class="string">"devDependencies"</span>: {
        <span class="string">"grunt"</span>: <span class="string">"~0.4.1"</span>
    }
}</code></pre></div><hr>
<p><strong>Gruntfile.js</strong></p>
<p>接下来该grunt介入了，先写下通用式：</p>
<div class="highlight"><pre><code class="javascript">module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(grunt)</span> {</span>
};</code></pre></div><p>由于该示例有模块依赖了css，估计你的项目现在或以后也有这种情况。
所以需要在<code>transport</code>的过程中对所依赖的css进行转换，以便seajs能加载一个类似这样的标签到页面中：</p>
<div class="highlight"><pre><code class="xml"><span class="tag">&lt;<span class="title">link</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">href</span>=<span class="value">"../styles/component/dialog/src/dialog_css.css"</span>&gt;</span></code></pre></div><p>seajs在<code>1.3.1</code>的版本中是将css文件也包装成一个js模块，以seajs.importStyle函数包裹原css内容。
这样在执行importStyle函数时，向页面添加一个上面的<code>link</code>标签。</p>
<p><em>ps：在新的2.0版本中，貌似该函数已从sea.js中剥离出来，形成一个单独的插件<code>style</code></em></p>
<p>为了实现上述的转换需要引入这样的代码：</p>
<div class="highlight"><pre><code class="javascript"><span class="keyword">var</span> transport = require(<span class="string">'grunt-cmd-transport'</span>);
<span class="keyword">var</span> style = transport.style.init(grunt);
<span class="keyword">var</span> text = transport.text.init(grunt);
<span class="keyword">var</span> script = transport.script.init(grunt);</code></pre></div><p>现在我们开始定义构建任务，先将<code>package.json</code>引入，后面的任务会用到其中的设置：</p>
<div class="highlight"><pre><code class="javascript">grunt.initConfig({
        pkg : grunt.file.readJSON(<span class="string">"package.json"</span>),
    });</code></pre></div><p>下面我们来看下自定义模块的构建任务。</p>
<hr>
<p><strong>自定义模块的<code>transport</code>任务：</strong></p>
<div class="highlight"><pre><code class="javascript">transport : {
    options : {
        paths : [<span class="string">'.'</span>],
        alias: <span class="string">'&lt;%= pkg.spm.alias %&gt;'</span>,
        parsers : {
            <span class="string">'.js'</span> : [script.jsParser],
            <span class="string">'.css'</span> : [style.css2jsParser],
            <span class="string">'.html'</span> : [text.html2jsParser]
        }
    },
    styles : {
        options : {
            idleading : <span class="string">'dist/styles/'</span>
        },
        files : [
            {
                cwd : <span class="string">'styles'</span>,
                src : <span class="string">'**/*'</span>,
                filter : <span class="string">'isFile'</span>,
                dest : <span class="string">'.build/styles'</span>
            }
        ]
    }
        }</code></pre></div><p>任务内容本身非常简单，就是将styles路径中的所有文件<code>cwd : &#39;styles&#39;</code>,<code>src : &#39;**/*&#39;</code>，也就是模块<code>dialog</code>，提取依赖并生成到<code>.build/styles</code>的临时目录中去。</p>
<p>这个任务包含了两级的<code>options</code>，<code>Target</code>的<code>options</code>会覆盖外层中<code>Task</code>的<code>options</code>，先说下<code>Task</code>的<code>options</code>中的含义：</p>
<ul>
<li><p>paths：模块的路径，默认的是<code>sea-modules</code>，如果你构建的时候出现找不的模块的话，可能就是这里出了问题。</p>
</li>
<li><p>alias：定义模块别名，这里以grunt支持的一种模板语法来从<code>package.json</code>引入定义：<code>&lt;%= pkg.spm.alias %&gt;</code></p>
</li>
<li><p>parsers：定义下针对不同格式文件的转换方式，这里的设置感觉以后很可能会在插件中内置，暂时先这么设置。</p>
</li>
</ul>
<p>紧接着看下<code>Task</code>中的<code>options</code>：</p>
<ul>
<li>idleading:模块ID的前缀</li>
</ul>
<hr>
<p><strong>自定义模块的<code>concat</code>任务：</strong></p>
<div class="highlight"><pre><code class="javascript">options : {
    paths : [<span class="string">'.'</span>],
    include : <span class="string">'relative'</span>
},
styles : {
    files: [
        {
            expand: <span class="literal">true</span>,
            cwd: <span class="string">'.build/'</span>,
            src: [<span class="string">'styles/**/*.js'</span>],
            dest: <span class="string">'dist/'</span>,
            ext: <span class="string">'.js'</span>
        }
    ]
}</code></pre></div><p>合并任务唯一要注意的地方就是其中<code>expand: true</code>的设置，该配置貌似是开启动态文件编译，就不用每个文件的合并策略都单独写啦！感谢 @Hsiaoming Yang 的指点。
官方描述：<a href="http://gruntjs.com/configuring-tasks#building-the-files-object-dynamically" title="building-the-files-object-dynamically">building-the-files-object-dynamically</a>
，其它没有什么特别的地方，就是将临时目录中的js合并后生成到<code>dist</code>目录中，只是需要额外说明下<code>options</code>：</p>
<ul>
<li><p>paths：与transport的paths相同。</p>
</li>
<li><p>include：relative的含义是合并采用相对路径依赖的模块，比如示例中自定义模块<code>dialog</code>的<code>require(&quot;./dialog_css.css&quot;)</code>。</p>
</li>
</ul>
<p>好啦，构建模块最主要的任务就这么完成了，下面再来看下业务模块的构建。</p>
<hr>
<p><strong>业务模块的<code>transport</code>任务：</strong></p>
<pre>transport : {
    app1 : {
        options : {
            idleading : &#39;app1/&#39;
        },
        files : [
            {
                cwd : &#39;app&#39;,
                src : &#39;**/*&#39;,
                filter : &#39;isFile&#39;,
                dest : &#39;.build/app&#39;
            }
        ]
    }
}</pre><p>有了上面自定义模块的构建基础，相信这里已经不需要我多余的解释了。那么马上看下业务模块的合并任务吧。</p>
<p><strong>业务模块的<code>concat</code>任务：</strong></p>
<div class="highlight"><pre><code class="javascript">concat : {
    app1 : {
        options : {
            include : <span class="string">'all'</span>
        },
        files: [
            {
                expand: <span class="literal">true</span>,
                cwd: <span class="string">'.build/'</span>,
                src: [<span class="string">'app/**/*.js'</span>],
                dest: <span class="string">'dist/'</span>,
                ext: <span class="string">'.js'</span>
            }
        ]
    }
}</code></pre></div><p>照例说明下<code>options</code>：</p>
<ul>
<li>include：由于是业务模块，理想的状况是除了seajs本身，我们就只需要业务相关的js及其所有依赖。那么all就是将所有依赖全都合并成一个文件。</li>
</ul>
<p>还要定义压缩和清理的任务，这里就非常简单了：</p>
<div class="highlight"><pre><code class="javascript">uglify : {
    styles : {
        files: [
            {
                expand: <span class="literal">true</span>,
                cwd: <span class="string">'dist/'</span>,
                src: [<span class="string">'styles/**/*.js'</span>, <span class="string">'!styles/**/*-debug.js'</span>],
                dest: <span class="string">'dist/'</span>,
                ext: <span class="string">'.js'</span>
            }
        ]
    },
    app1 : {
        files: [
            {
                expand: <span class="literal">true</span>,
                cwd: <span class="string">'dist/'</span>,
                src: [<span class="string">'app/**/*.js'</span>, <span class="string">'!app/**/*-debug.js'</span>],
                dest: <span class="string">'dist/'</span>,
                ext: <span class="string">'.js'</span>
            }
        ]
    }
},
clean : {
    spm : [<span class="string">'.build'</span>]
}</code></pre></div><p>ps:<code>!styles/**/*-debug.js</code>的意思是<code>*-debug.js</code>文件不压缩。</p>
<p>好了，接下来需要告诉grunt如何来执行这些任务：</p>
<div class="highlight"><pre><code class="javascript">    grunt.loadNpmTasks(<span class="string">'grunt-cmd-transport'</span>);
    grunt.loadNpmTasks(<span class="string">'grunt-cmd-concat'</span>);
    grunt.loadNpmTasks(<span class="string">'grunt-contrib-clean'</span>);
    grunt.loadNpmTasks(<span class="string">'grunt-contrib-uglify'</span>);

    grunt.registerTask(<span class="string">'build-styles'</span>, [<span class="string">'transport:styles'</span>, <span class="string">'concat:styles'</span>, <span class="string">'uglify:styles'</span>, <span class="string">'clean'</span>]);
    grunt.registerTask(<span class="string">'build-app1'</span>, [<span class="string">'transport:app1'</span>, <span class="string">'concat:app1'</span>, <span class="string">'uglify:app1'</span>, <span class="string">'clean'</span>]);
<span class="comment">//  grunt.registerTask('default', ['clean']);</span></code></pre></div><p><em>ps:这里将grunt的默认任务<code>default</code>只设置为<code>clean</code>，避免误操作。</em></p>
<p>最后到命令行执行下grunt，看看效果吧！</p>
<pre>grunt build-styles</pre><pre>grunt build-app1</pre><p>再唠叨两句，这里之所以这样设置任务，是考虑到项目中的自定义模块，改动的几率要比业务模块低很多，
可以先构建好，并在<code>package.json</code>中设置好<code>alias</code>，每个项目在上线前构建一次业务模块即可。</p>
<hr>
<p>最后的最后，将调试用的<code>rootConfig.js</code>去掉，然后页面中的<code>index.js</code>路径替换成构建好的js，路径中app前面的部分一般都是以<code>php</code>,<code>java</code>等变量代替，
这样只需要在变量中定义好上线路径，前端基本就不需要在项目上线的时候关心这里啦：）</p>
<div class="highlight"><pre><code class="javascript">seajs.use(<span class="string">"../../dist/app/app1/index/src/index.js"</span>)</code></pre></div><hr>
<p><strong>最后感谢seajs,spm,grunt，让我的前端工作变得更轻松了。</strong></p>
<p>以下是完整的<code>Gruntfile.js</code>：</p>
<div class="highlight"><pre><code class="javascript">module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(grunt)</span> {</span>
    <span class="keyword">var</span> transport = require(<span class="string">'grunt-cmd-transport'</span>);
    <span class="keyword">var</span> style = transport.style.init(grunt);
    <span class="keyword">var</span> text = transport.text.init(grunt);
    <span class="keyword">var</span> script = transport.script.init(grunt);
    grunt.initConfig({
        pkg : grunt.file.readJSON(<span class="string">"package.json"</span>),
        transport : {
            options : {
                paths : [<span class="string">'.'</span>],
                alias: <span class="string">'&lt;%= pkg.spm.alias %&gt;'</span>,
                parsers : {
                    <span class="string">'.js'</span> : [script.jsParser],
                    <span class="string">'.css'</span> : [style.css2jsParser],
                    <span class="string">'.html'</span> : [text.html2jsParser]
                }
            },
            styles : {
                options : {
                    idleading : <span class="string">'dist/styles/'</span>
                },
                files : [
                    {
                        cwd : <span class="string">'styles/'</span>,
                        src : <span class="string">'**/*'</span>,
                        filter : <span class="string">'isFile'</span>,
                        dest : <span class="string">'.build/styles'</span>
                    }
                ]
            },
            app1 : {
                options : {
                    idleading : <span class="string">'app1/'</span>
                },
                files : [
                    {
                        cwd : <span class="string">'app'</span>,
                        src : <span class="string">'**/*'</span>,
                        filter : <span class="string">'isFile'</span>,
                        dest : <span class="string">'.build/app'</span>
                    }
                ]
            }
        },
        concat : {
            options : {
                paths : [<span class="string">'.'</span>],
                include : <span class="string">'relative'</span>
            },
            styles : {
                files: [
                    {
                        expand: <span class="literal">true</span>,
                        cwd: <span class="string">'.build/'</span>,
                        src: [<span class="string">'styles/**/*.js'</span>],
                        dest: <span class="string">'dist/'</span>,
                        ext: <span class="string">'.js'</span>
                    }
                ]
            },
            app1 : {
                options : {
                    include : <span class="string">'all'</span>
                },
                files: [
                    {
                        expand: <span class="literal">true</span>,
                        cwd: <span class="string">'.build/'</span>,
                        src: [<span class="string">'app/**/*.js'</span>],
                        dest: <span class="string">'dist/'</span>,
                        ext: <span class="string">'.js'</span>
                    }
                ]
            }
        },
        uglify : {
            styles : {
                files: [
                    {
                        expand: <span class="literal">true</span>,
                        cwd: <span class="string">'dist/'</span>,
                        src: [<span class="string">'styles/**/*.js'</span>, <span class="string">'!styles/**/*-debug.js'</span>],
                        dest: <span class="string">'dist/'</span>,
                        ext: <span class="string">'.js'</span>
                    }
                ]
            },
            app1 : {
                files: [
                    {
                        expand: <span class="literal">true</span>,
                        cwd: <span class="string">'dist/'</span>,
                        src: [<span class="string">'app/**/*.js'</span>, <span class="string">'!app/**/*-debug.js'</span>],
                        dest: <span class="string">'dist/'</span>,
                        ext: <span class="string">'.js'</span>
                    }
                ]
            }
        },
        clean : {
            spm : [<span class="string">'.build'</span>]
        }
    });
    grunt.loadNpmTasks(<span class="string">'grunt-cmd-transport'</span>);
    grunt.loadNpmTasks(<span class="string">'grunt-cmd-concat'</span>);
    grunt.loadNpmTasks(<span class="string">'grunt-contrib-clean'</span>);
    grunt.loadNpmTasks(<span class="string">'grunt-contrib-uglify'</span>);
    grunt.registerTask(<span class="string">'build-styles'</span>, [<span class="string">'transport:styles'</span>, <span class="string">'concat:styles'</span>, <span class="string">'uglify:styles'</span>, <span class="string">'clean'</span>]);
    grunt.registerTask(<span class="string">'build-app1'</span>, [<span class="string">'transport:app1'</span>, <span class="string">'concat:app1'</span>, <span class="string">'uglify:app1'</span>, <span class="string">'clean'</span>]);
<span class="comment">//    grunt.registerTask('default', ['clean']);</span>
};</code></pre></div></div>
</div>
</div>
    </div>
    <div class="footer">
      <p class="copyright">powered by <a href="http://lab.lepture.com/nico/">nico</a> 0.5.0</p>
    </div>
    <script src="http://static.alipayobjects.com/seajs/1.2.1/sea.js" data-main="../static/one.js"></script>
    <div id="extra">
        <a href="https://github.com/spmjs/spm2" target="_blank">
            <img src="https://i.alipayobjects.com/e/201211/1dbSqT9ykm.png" width="149" height="149" alt="Fork me on GitHub"></a>
    </div>
    <!--<div class="github"><a class="github-link" href="https://github.com/spmjs/spm2">Fork me on GitHub</a></div>-->
  </body>
</html>